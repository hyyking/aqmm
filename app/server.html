<!DOCTYPE HTML>
<html lang="fr" class="sidebar-visible no-js coal">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Serveur - Projet CMI L3 - A Quick Marker Maker (aqmm)</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "coal" : "coal";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('coal')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../introduction.html">Introduction</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">Théorie</li><li class="chapter-item expanded "><a href="../mm/intro.html"><strong aria-hidden="true">1.</strong> Animateur de marché automatisé</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../mm/costfn.html"><strong aria-hidden="true">1.1.</strong> Fonction de coût</a></li><li class="chapter-item expanded "><a href="../mm/ghpm.html"><strong aria-hidden="true">1.2.</strong> Gates Hillman Prediction Market</a></li></ol></li><li class="chapter-item expanded "><a href="../async/intro.html"><strong aria-hidden="true">2.</strong> Programmation Asynchrone</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../async/futures.html"><strong aria-hidden="true">2.1.</strong> &quot;Future&quot; en language Rust</a></li><li class="chapter-item expanded "><a href="../async/executor.html"><strong aria-hidden="true">2.2.</strong> Executeur</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><li class="part-title">Pratique</li><li class="chapter-item expanded "><a href="../app/intro.html"><strong aria-hidden="true">3.</strong> Structure de l'application</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../app/protocol.html"><strong aria-hidden="true">3.1.</strong> Protocol</a></li><li class="chapter-item expanded "><a href="../app/server.html" class="active"><strong aria-hidden="true">3.2.</strong> Serveur</a></li><li class="chapter-item expanded "><a href="../app/clients.html"><strong aria-hidden="true">3.3.</strong> Clients</a></li></ol></li><li class="chapter-item expanded "><a href="../server/intro.html"><strong aria-hidden="true">4.</strong> Serveur</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../server/executor.html"><strong aria-hidden="true">4.1.</strong> Executeur à un thread</a></li><li class="chapter-item expanded "><a href="../server/io.html"><strong aria-hidden="true">4.2.</strong> Ressources I/O</a></li><li class="chapter-item expanded "><a href="../server/market.html"><strong aria-hidden="true">4.3.</strong> Marché</a></li></ol></li><li class="chapter-item expanded "><a href="../result/intro.html"><strong aria-hidden="true">5.</strong> Experience</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../result/setup.html"><strong aria-hidden="true">5.1.</strong> Mise en place</a></li><li class="chapter-item expanded "><a href="../result/strategies.html"><strong aria-hidden="true">5.2.</strong> Stratégies</a></li><li class="chapter-item expanded "><a href="../result/results.html"><strong aria-hidden="true">5.3.</strong> Résultats</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../conclusion.html">Conclusion</a></li><li class="chapter-item expanded affix "><a href="../documentation.html">Documentation</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Projet CMI L3 - A Quick Marker Maker (aqmm)</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        <a href="https://github.com/hyyking/aqmm" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#serveur" id="serveur">Serveur</a></h1>
<p>Dans cette partie nous verrons a construction du serveur, ce dernier est répartit en plusieurs
modules le premier étant celui des ressources Input/Output c'est à dire concernant les abstractions
liés aux notifications système. Un deuxième module connexe au premier fait la liaison entre les
entrée de notification systeme et les connections TCP permettant à ces dernières d'être entièrement
asynchrones. Un dernier est lié au marché avec la liste des titres et les modules d'execution
d'ordre.</p>
<p>Structure des éléments de l'application (dossiers et fichiers non pertinents omis):</p>
<pre><code>.
├── build.rs			-&gt; script de compilation, génère le code protobuf
├── Cargo.toml			-&gt; fichier de spécification du projet
├── src
│   ├── lib.rs
│   ├── ...
│   ├── net
│   │   ├── mod.rs
│   │   ├── codec.rs
│   │   └── tcp.rs
│   ├── market
│   │   ├── securities.rs
│   │   ├── core.rs
│   │   ├── mod.rs
│   │   ├── pool.rs
│   │   └── router.rs
│   ├── io
│   │   ├── mod.rs
│   │   ├── registration.rs
│   │   └── driver
│   │       ├── context.rs
│   │       └── mod.rs
│   ├── server.rs
│   └── bin			-&gt; binaires executables
├── proto
│   └── aqmm.proto		-&gt; protocol en protobuf
└── ...
</code></pre>
<h2><a class="header" href="#executeur-et-io" id="executeur-et-io">Executeur et I/O</a></h2>
<p>La structure du serveur (dans le fichier <code>src/server.rs</code>) est composé d'un &quot;driver&quot; pour les
ressources I/O liés aux connections arrivant. Le but du serveur est d'écouter les connections
arrivantes et pour chaque connection d'executer un client qui prend la forme d'un future. A chaque
client est associé une connection ainsi qu'une session. Afin de determiner quels clients ont une
action de prête le serveur utilise la librairie <a href="https://docs.rs/mio"><code>mio</code></a> qui permet d'associer
des ressources I/O et d'emettre des notifications sur les connections ayant du travail. Les
evennements sont ensuite transferé à des entrées contenant les <code>std::task::Waker</code> des streams de
message des clients ces messages sont ensuite décodés et une réponse est envoyé suviant le protocole
décrit dans la partie précédente.</p>
<h2><a class="header" href="#networking" id="networking">Networking</a></h2>
<p>Le module <code>src/net</code> contient tous les elements nécéssaire au maintient et à l'utilisation des
connections.</p>
<h3><a class="header" href="#tcpsream" id="tcpsream">TcpSream</a></h3>
<p>Le driver de ressources I/O permet de savoir quand une connection est en mesure d'être écrite/lu. De
cette manière le driver peut reveiller les <code>Waker</code> associés. Il manque seulement un <em>trait</em> comme
<code>std::future::Future</code> mais pour les actions de lecture et d'ecriture d'un flux de donnée. Le
language expose les <em>traits</em> synchrone <code>std::io::Read</code> et <code>std::io::Write</code>. La libraire <code>futures</code>
définit de la même facon <code>futures::io::AsyncRead</code> et <code>futures::io::AsyncWrite</code>. Ainsi avec le driver
I/O nous pouvons construire une abstraction par dessus un TcpStream synchrone qui implémente
<code>AsyncRead + AsyncWrite</code></p>
<h3><a class="header" href="#codec" id="codec">Codec</a></h3>
<p>Les codecs sont construits sur les <em>traits</em> <code>tokio_util::codec::Encoder</code> et
<code>tokio_util::codec::Decoder</code> trouvé dans la librairie <a href="https://docs.rs/tokio_codec"><code>tokio_util</code></a>.
Le module expose un codec client, qui encode des requêtes et décode des responses ainsi qu'un codec
serveur qui encode les réponses et décode les requetes.</p>
<p>L'interet d'exposer ces codec est de pouvoir utiliser la structure <code>tokio_util::codec::Framed</code>
exposé par la meme libraire. La structure permet de créer un stream et un &quot;sink&quot; depuis un codec
(<code>Encoder + Decoder</code>) et une structure pouvant être lu/écrite de manière asynchrone
(<code>AsyncRead + AsyncWrite</code>). Le stream renvois ainsi les objets décodés et le &quot;sink&quot; permet d'envoyer
des objets qui seront encodés puis envoyés sur la connection.</p>
<h2><a class="header" href="#market" id="market">Market</a></h2>
<p>Le marché est composé de plusieurs éléments. La structure principale qui sert de pointeur vers un
état partagé qui comprend une liste des coeurs du marché et un accès au routeur d'ordres. Tous les
coeurs ont également un pointeur vers un une structure partagé contenant le compte de chaque titres
ainsi qu'un accès au multicast.</p>
<p>Le but de cette structure est de servire d'interface partagé entre tous les clients pour envoyer des
ordres en contrepartie d'un future sur le resultat de cet ordre.</p>
<h3><a class="header" href="#routercoeurs" id="routercoeurs">Router/Coeurs</a></h3>
<p>Le router d'ordre est un structure faisant part du marché son but est d'envoyer les ordres sur les
différents coeurs. Les stratégies de routage des ordres peuvent être plus ou moins complexe. En
effet, Les le but des coeurs est d'executer des ordres cependant on pourrait se retrouver dans une
situation ou un coeur recoit tous les ordres tandis que les autres ne font rien gachant ainsi du
temps de processeur. Par exemple, on pourrait imaginer une stratégie ou les ordres sont triés et en
fonction des titres visés sont envoyé sur un coeurs différent. Dans le cadre de ce projet le router
est plutot basique et agit comme une roue distribuant tour à tour à chaque coeur. Les points de
sortis des router implémente égalment le <em>trait</em> <code>futures::stream::Stream</code> de manière à ce que les
coeurs ne soient actifs que lorsque des ordres arrivent (et ainsi les notifiants).</p>
<p>Le coeur du marché est lancé sur un processus différent, il s'agit d'une structure asynchrone qui
attend les ordres du router. Une fois l'ordre reçu il tente attend de pouvoir avoir un accès
exclusifs aux quantités du market maker. Une fois les quantités acquises il calcule le score pour
les anciennes et le score pour les nouvelles après avoir executé tous les ordres determinant le prix
de la transaction. Une fois le verrous des quantités levé il tente de partager les nouvelles
quantités.</p>
<h3><a class="header" href="#securitiespool" id="securitiespool">Securities/Pool</a></h3>
<p>Le fichier <code>src/market/securities.rs</code> permet d'editer les titres avant la compilation et contient
également des fonctions y facilitant l'accès. Le fichier définit également un autre type
<code>Securities</code> dont la description est du texte statique car il est, pour le moment, impossible de
créer statiquement (comprendre lors de la compilation) un pointeur de type <code>String</code> requis par prost
pour les entrés type string en protobuf.</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>const SECURITIES: &amp;'static [Security] = &amp;[
    Security {
        security_id: 0,
        description: &quot;first security&quot;,
    },
    Security {
        security_id: 1,
        description: &quot;second security&quot;,
    },
    Security {
        security_id: 2,
        description: &quot;third security&quot;,
    },
];}
<span class="boring">}
</span></code></pre></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../app/protocol.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../app/clients.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../app/protocol.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../app/clients.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
